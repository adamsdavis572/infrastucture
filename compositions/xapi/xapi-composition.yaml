apiVersion: apiextensions.crossplane.io/v1
kind: Composition
metadata:
  name: apiinstances.platform.my-org.co
  labels:
    provider: azure
spec:
  compositeTypeRef:
    apiVersion: platform.my-org.co/v1alpha1
    kind: ApiInstance
  mode: Pipeline
  pipeline:
  - step: patch-and-transform
    functionRef:
      name: function-patch-and-transform
    input:
      apiVersion: pt.fn.crossplane.io/v1beta1
      kind: Resources
      resources:
        - name: api
          base:
            apiVersion: apimanagement.azure.upbound.io/v1beta1
            kind: API
            metadata:
              annotations:
                crossplane.io/external-name: ""
            spec:
              forProvider:
                apiManagementNameSelector:
                  matchLabels:
                    xingress: ""
                displayName: ""
                path: ""
                protocols:
                  - "https"
                revision: "1"
                import:
                  - contentFormat: openapi
                    contentValue: ""
                resourceGroupNameSelector:
                  matchLabels:
                    xingress: ""
          patches:
            - type: FromCompositeFieldPath
              fromFieldPath: spec.apiName
              toFieldPath: metadata.labels.xapi
            - type: FromCompositeFieldPath
              fromFieldPath: "spec.ingressRef"
              toFieldPath: "spec.forProvider.apiManagementNameSelector.matchLabels.xingress"
            - type: FromCompositeFieldPath
              fromFieldPath: "spec.ingressRef"
              toFieldPath: "spec.forProvider.resourceGroupNameSelector.matchLabels.xingress"
            - type: FromCompositeFieldPath
              fromFieldPath: "spec.apiName"
              toFieldPath: "spec.forProvider.displayName"
            - type: FromCompositeFieldPath
              fromFieldPath: "spec.apiName"
              toFieldPath: "metadata.annotations[crossplane.io/external-name]"
            - type: FromCompositeFieldPath
              fromFieldPath: "spec.apiPath"
              toFieldPath: "spec.forProvider.path"
            - type: FromCompositeFieldPath
              fromFieldPath: "spec.apiProtocols"
              toFieldPath: "spec.forProvider.protocols"
            - type: FromCompositeFieldPath
              fromFieldPath: "spec.swaggerDefinition"
              toFieldPath: "spec.forProvider.import[0].contentValue"
            - type: FromCompositeFieldPath
              fromFieldPath: "spec.swaggerFormat"
              toFieldPath: "spec.forProvider.import[0].contentFormat"
        
        - name: gateway-api
          base:
            apiVersion: apimanagement.azure.upbound.io/v1beta1
            kind: GatewayAPI
            spec:
              forProvider:
                apiIdSelector:
                  matchControllerRef: true
                gatewayIdSelector:
                  matchLabels:
                    xingress: ""
          patches:
            - type: FromCompositeFieldPath
              fromFieldPath: "spec.ingressRef"
              toFieldPath: "spec.forProvider.gatewayIdSelector.matchLabels.xingress"